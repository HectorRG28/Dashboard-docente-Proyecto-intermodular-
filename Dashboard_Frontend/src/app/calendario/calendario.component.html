<div class="layout-wrapper"> <!-- Estructura unificada -->
  
  <aside class="sidebar">
    <h2 class="app-title" (click)="irAHoy()">üìÖ Calendario Mensual</h2>
    <div style="display: flex; gap: 5px;">
      <button class="btn-crear" (click)="abrirModalCrear()">+ Crear Tarea</button>
    </div>

    <div class="mini-calendar-container">
      <div class="mini-header">
        <button (click)="cambiarMes(-1)">‚Äπ</button>
        <span>{{ nombresMeses[mesActualVisual.getMonth()] }} {{ mesActualVisual.getFullYear() }}</span>
        <button (click)="cambiarMes(1)">‚Ä∫</button>
      </div>
      <div class="mini-week-header">
        <span>L</span><span>M</span><span>X</span><span>J</span><span>V</span><span>S</span><span>D</span>
      </div>
      <div class="mini-days-grid">
        <div *ngFor="let dia of diasMiniCalendario" 
             class="mini-day" 
             [class.today-day]="dia.esHoy"
             (click)="!dia.esHueco && seleccionarDia(dia.numero)">
          {{ dia.numero }}
        </div>
      </div>
    </div>

    <!-- Men√∫ lateral igualado -->
    <nav class="menu-lateral">
      <ul>
        <li (click)="irAMiHorario()">üïí Mi Horario (Semanal)</li>
        <li (click)="toggleAjustes()">‚öôÔ∏è Configuraci√≥n</li>
      </ul>
    </nav>
  </aside>

  <main class="main-content">
    <div class="top-bar">
      <h1>{{ nombresMeses[mesActualVisual.getMonth()] }} {{ mesActualVisual.getFullYear() }}</h1>
      <div class="pill-toggle">
         <button class="pill-btn active">‚úì Tareas</button>
         <button class="pill-btn">‚ìß Completado</button>
      </div>
    </div>

    <div class="calendar-grid">
      <div class="day-header" *ngFor="let dia of diasSemana">{{ dia }}</div>

      <div class="cal-cell" *ngFor="let celda of celdasCalendario">
        
        <span class="day-num" *ngIf="!celda.esHueco">{{ celda.numero }}</span>

        <div class="eventos-container" *ngIf="!celda.esHueco">
          
          <div class="evento-chip" 
               *ngFor="let evento of celda.eventos"
               [title]="evento.titulo + ': ' + evento.descripcion"
               (click)="abrirModalVer(evento)">
            
            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display:flex; gap:5px; align-items:center;">
               <span class="evento-hora">{{ formatTime(evento.fecha_inicio) }}</span>
               <span class="evento-titulo">{{ evento.titulo }}</span>
            </div>

            <span (click)="borrarTarea(evento.id_actividad || evento.id, $event)" 
                  style="color: red; font-weight: bold; cursor: pointer; margin-left: auto; padding-left:5px; font-size: 12px;">
              ‚úñ
            </span>
          
          </div>

        </div>

      </div>
    </div>
  </main>
</div>

<!-- MODAL AJUSTES (REUTILIZADO) -->
<div class="modal-overlay" *ngIf="mostrarAjustes" (click)="toggleAjustes()">
  <div class="modal-content settings-modal" (click)="$event.stopPropagation()">
    <div class="modal-header"><h2>Configuraci√≥n</h2><button class="close-btn" (click)="toggleAjustes()">√ó</button></div>
    <div class="modal-body">
      <app-ajustes [embed]="true"></app-ajustes>
    </div>
  </div>
</div>

<!-- MODAL TAREAS (NUEVO) -->
<div class="modal-overlay" *ngIf="modalAbierto" (click)="cerrarModal()">
  <div class="modal-content task-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modoModal === 'CREAR' ? 'Nueva Tarea' : (modoModal === 'EDITAR' ? 'Editar' : 'Detalles') }}</h2>
      <button class="close-btn" (click)="cerrarModal()">√ó</button>
    </div>

    <div class="modal-body ver-detalles" *ngIf="modoModal === 'VER' && tareaSeleccionada">
      <h3>{{ tareaSeleccionada.titulo }}</h3>
      <div class="detalle-row"><strong>Hora:</strong> {{ formatTime(tareaSeleccionada.fecha_inicio) }}</div>
      <div class="detalle-row"><strong>Aula:</strong> {{ tareaSeleccionada.aula || 'Sin aula' }}</div>
      <div class="desc-box">{{ tareaSeleccionada.descripcion }}</div>
      
      <div class="modal-actions right">
        <button class="btn-secondary" (click)="activarModoEdicion()">‚úèÔ∏è Editar</button>
        <button class="btn-danger" (click)="borrarTareaDesdeModal()">üóëÔ∏è Borrar</button>
      </div>
    </div>

    <div class="modal-body" *ngIf="modoModal === 'CREAR' || modoModal === 'EDITAR'">
      <form (ngSubmit)="guardarTarea()">
        <div class="form-group">
          <label>T√≠tulo</label>
          <input type="text" [(ngModel)]="formularioTarea.titulo" name="titulo" required>
        </div>
        <div class="row-inputs">
          <div class="half"><label>Fecha</label><input type="date" [(ngModel)]="formularioTarea.fecha" name="fecha" required></div>
          <div class="half"><label>Hora Inicio</label><input type="time" [(ngModel)]="formularioTarea.horaInicio" name="hora" required></div>
          <div class="half"><label>Hora Fin</label><input type="time" [(ngModel)]="formularioTarea.horaFin" name="horaFin"></div>
        </div>
        
        <div class="row-inputs">
           <div class="half">
             <label>Aula</label>
             <input type="text" [(ngModel)]="formularioTarea.aula" name="aula" placeholder="Ej: A102">
           </div>
           <div class="half">
             <label>Tipo</label>
             <select [(ngModel)]="formularioTarea.id_tipo" name="tipo">
               <option *ngFor="let t of listaTipos" [value]="t.id_tipo">{{ t.nombre_tipo || t.nombre || t.tipo }}</option>
             </select>
           </div>
        </div>

        <div class="form-group">
          <label>M√≥dulo</label>
          <select [(ngModel)]="formularioTarea.id_modulo_seleccionado" name="modulo">
            <option *ngFor="let m of listaModulos" [value]="m.id_modulo">{{ m.nombre || m.nombre_modulo }}</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea [(ngModel)]="formularioTarea.descripcion" name="desc" rows="3"></textarea>
        </div>

        <div class="modal-actions right">
          <button type="button" class="btn-cancel" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-save">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>
